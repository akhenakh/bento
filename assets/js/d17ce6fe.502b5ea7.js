"use strict";(self.webpackChunkbento=self.webpackChunkbento||[]).push([[8055],{56145:function(e,n,t){t.r(n),t.d(n,{contentTitle:function(){return r},default:function(){return d},frontMatter:function(){return s},metadata:function(){return l},toc:function(){return c}});var o=t(85893),i=t(11151);const s={slug:"filtering",title:"Filtering and Sampling",description:"Configure Bento to conditionally drop messages."},r=void 0,l={permalink:"/bento/cookbooks/filtering",source:"@site/cookbooks/filtering.md",title:"Filtering and Sampling",description:"Configure Bento to conditionally drop messages."},c=[{value:"The Basic Filter",id:"the-basic-filter",level:2},{value:"Sample Events",id:"sample-events",level:2}];function a(e){const n={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["Events are like eyebrows, sometimes it's best to just get rid of them. Filtering events in Bento is both easy and flexible, this cookbook demonstrates a few different types of filtering you can do. All of these examples make use of the ",(0,o.jsxs)(n.a,{href:"/docs/components/processors/mapping",children:[(0,o.jsx)(n.code,{children:"mapping"})," processor"]})," but shouldn't require any prior knowledge."]}),"\n",(0,o.jsx)(n.h2,{id:"the-basic-filter",children:"The Basic Filter"}),"\n",(0,o.jsxs)(n.p,{children:["Dropping events with ",(0,o.jsx)(n.a,{href:"/docs/guides/bloblang/about",children:"Bloblang"})," is done by mapping the function ",(0,o.jsx)(n.code,{children:"deleted()"})," to the ",(0,o.jsx)(n.code,{children:"root"})," of the mapped document. To remove all events indiscriminately you can simply do:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"pipeline:\n  processors:\n  - mapping: root = deleted()\n"})}),"\n",(0,o.jsxs)(n.p,{children:["But that's most likely not what you want. We can instead only delete an event under certain conditions with a ",(0,o.jsx)(n.a,{href:"/docs/guides/bloblang/about#pattern-matching",children:(0,o.jsx)(n.code,{children:"match"})})," or ",(0,o.jsx)(n.a,{href:"/docs/guides/bloblang/about#conditional-mapping",children:(0,o.jsx)(n.code,{children:"if"})})," expression:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'pipeline:\n  processors:\n  - mapping: |\n      root = if @topic.or("") == "foo" ||\n        this.doc.type == "bar" ||\n        this.doc.urls.contains("https://www.benthos.dev/").catch(false) {\n        deleted()\n      }\n'})}),"\n",(0,o.jsx)(n.p,{children:"The above config removes any events where:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["The metadata field ",(0,o.jsx)(n.code,{children:"topic"})," is equal to ",(0,o.jsx)(n.code,{children:"foo"})]}),"\n",(0,o.jsxs)(n.li,{children:["The event field ",(0,o.jsx)(n.code,{children:"doc.type"})," (a string) is equal to ",(0,o.jsx)(n.code,{children:"bar"})]}),"\n",(0,o.jsxs)(n.li,{children:["The event field ",(0,o.jsx)(n.code,{children:"doc.urls"})," (an array) contains the string ",(0,o.jsx)(n.code,{children:"https://www.benthos.dev/"})]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Events that do not match any of these conditions will remain unchanged."}),"\n",(0,o.jsx)(n.h2,{id:"sample-events",children:"Sample Events"}),"\n",(0,o.jsx)(n.p,{children:"Another type of filter we might want is a sampling filter, we can do that with a random number generator:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"pipeline:\n  processors:\n  - mapping: |\n      # Drop 50% of documents randomly\n      root = if random_int() % 2 == 0 { deleted() }\n"})}),"\n",(0,o.jsx)(n.p,{children:"We can also do this in a deterministic way by hashing events and filtering by that hash value:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:'pipeline:\n  processors:\n  - mapping: |\n      # Drop ~10% of documents deterministically (same docs filtered each run)\n      root = if content().hash("xxhash64").slice(-8).number() % 10 == 0 {\n         deleted()\n      }\n'})})]})}function d(e){void 0===e&&(e={});const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(a,{...e})}):a(e)}},11151:function(e,n,t){t.d(n,{Z:function(){return l},a:function(){return r}});var o=t(67294);const i={},s=o.createContext(i);function r(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);