"use strict";(self.webpackChunkbento=self.webpackChunkbento||[]).push([[224],{96710:function(e,n,t){t.r(n),t.d(n,{assets:function(){return l},contentTitle:function(){return a},default:function(){return u},frontMatter:function(){return r},metadata:function(){return i},toc:function(){return c}});var o=t(85893),s=t(11151);const r={title:"Lambda",description:"Deploying Bento as an AWS Lambda function"},a=void 0,i={id:"guides/serverless/lambda",title:"Lambda",description:"Deploying Bento as an AWS Lambda function",source:"@site/docs/guides/serverless/lambda.md",sourceDirName:"guides/serverless",slug:"/guides/serverless/lambda",permalink:"/bento/docs/guides/serverless/lambda",draft:!1,unlisted:!1,editUrl:"https://github.com/warpstreamlabs/bento/edit/main/website/docs/guides/serverless/lambda.md",tags:[],version:"current",frontMatter:{title:"Lambda",description:"Deploying Bento as an AWS Lambda function"},sidebar:"docs",previous:{title:"About",permalink:"/bento/docs/guides/serverless/about"},next:{title:"About",permalink:"/bento/docs/guides/streams_mode/about"}},l={},c=[{value:"Running with an output",id:"running-with-an-output",level:3},{value:"Running without an output",id:"running-without-an-output",level:3},{value:"Processing Errors",id:"processing-errors",level:4},{value:"Running a combination",id:"running-a-combination",level:3},{value:"Upload to AWS",id:"upload-to-aws",level:2},{value:"go1.x on x86_64",id:"go1x-on-x86_64",level:3},{value:"provided.al2 on amd64",id:"providedal2-on-amd64",level:3},{value:"Invoke",id:"invoke",level:2},{value:"Build",id:"build",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"bento-lambda"})," distribution is a version of Bento specifically tailored\nfor deployment as an AWS Lambda function on the ",(0,o.jsx)(n.code,{children:"go1.x"})," runtime,\nwhich runs Amazon Linux on the ",(0,o.jsx)(n.code,{children:"x86_64"})," architecture.\nThe ",(0,o.jsx)(n.code,{children:"bento-lambda-al2"})," distribution supports the ",(0,o.jsx)(n.code,{children:"provided.al2"})," runtime,\nwhich runs Amazon Linux 2 on either the ",(0,o.jsx)(n.code,{children:"x86_64"})," or ",(0,o.jsx)(n.code,{children:"arm64"})," architecture."]}),"\n",(0,o.jsx)(n.admonition,{title:"Looking for something less manual?",type:"info",children:(0,o.jsxs)(n.p,{children:["Rather than bundle the distribution and configs yourself,\ncheck out ",(0,o.jsx)(n.a,{href:"https://github.com/makenew/serverless-bento",children:"makenew/serverless-bento"}),", which makes quick work of deploying\na Bento serverless project on AWS Lambda.\nFor building and deploying distributions with custom plugins,\nlook at ",(0,o.jsx)(n.a,{href:"https://github.com/makenew/bento-plugin",children:"makenew/bento-plugin"}),"."]})}),"\n",(0,o.jsx)(n.p,{children:"It uses the same configuration format as a regular Bento instance, which can be\nprovided in 1 of 2 ways:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Inline via the ",(0,o.jsx)(n.code,{children:"BENTO_CONFIG"})," environment variable (YAML format)."]}),"\n",(0,o.jsxs)(n.li,{children:["Via the filesystem using a layer, extension, or container image. By default,\nthe ",(0,o.jsx)(n.code,{children:"bento-lambda"})," distribution will look for a valid configuration file in\nthe locations listed below. Alternatively, the configuration file path can be\nset explicity by passing a ",(0,o.jsx)(n.code,{children:"BENTO_CONFIG_PATH"})," environment variable."]}),"\n"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"./bento.yaml"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"./config.yaml"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"/bento.yaml"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"/etc/bento/config.yaml"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.code,{children:"/etc/bento.yaml"})}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Also, the ",(0,o.jsx)(n.code,{children:"http"}),", ",(0,o.jsx)(n.code,{children:"input"})," and ",(0,o.jsx)(n.code,{children:"buffer"})," sections are ignored as the service wide\nHTTP server is not used, and messages are inserted via function invocations."]}),"\n",(0,o.jsxs)(n.p,{children:["If the ",(0,o.jsx)(n.code,{children:"output"})," section is omitted in your config then the result of the\nprocessing pipeline is returned back to the caller, otherwise the resulting data\nis sent to the output destination."]}),"\n",(0,o.jsx)(n.h3,{id:"running-with-an-output",children:"Running with an output"}),"\n",(0,o.jsx)(n.p,{children:"The flow of a Bento lambda function with an output configured looks like this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-text",children:"                    bento-lambda\n           +------------------------------+\n           |                              |\n       -------\x3e Processors ----\x3e Output -----\x3e Somewhere\ninvoke     |                              |        |\n       <-------------------------------------------/\n           |         <Ack/Noack>          |\n           |                              |\n           +------------------------------+\n"})}),"\n",(0,o.jsxs)(n.p,{children:["Where the call will block until the output target has confirmed receipt of the\nresulting payload. When the message is successfully propagated a JSON payload is\nreturned of the form ",(0,o.jsx)(n.code,{children:'{"message":"request successful"}'}),", otherwise an error is\nreturned containing the reason for the failure."]}),"\n",(0,o.jsx)(n.h3,{id:"running-without-an-output",children:"Running without an output"}),"\n",(0,o.jsx)(n.p,{children:"The flow when an output is not configured looks like this:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-text",children:"               bento-lambda\n           +--------------------+\n           |                    |\n       -------\x3e Processors --\\  |\ninvoke     |                 |  |\n       <---------------------/  |\n           |     <Result>       |\n           |                    |\n           +--------------------+\n"})}),"\n",(0,o.jsx)(n.p,{children:"Where the function returns the result of processing directly back to the caller.\nThe format of the result differs depending on the number of batches and messages\nof a batch that resulted from the invocation:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Single message of a single batch: ",(0,o.jsx)(n.code,{children:"{}"})," (JSON object)"]}),"\n",(0,o.jsxs)(n.li,{children:["Multiple messages of a single batch: ",(0,o.jsx)(n.code,{children:"[{},{}]"})," (Array of JSON objects)"]}),"\n",(0,o.jsxs)(n.li,{children:["Multiple batches: ",(0,o.jsx)(n.code,{children:"[[{},{}],[{}]]"})," (Array of arrays of JSON objects, batches\nof size one are a single object array in this case)"]}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"processing-errors",children:"Processing Errors"}),"\n",(0,o.jsx)(n.p,{children:"The default behaviour of a Bento lambda is that the handler will not return an\nerror unless the output fails. This means that errors that occur within your\nprocessors will not result in the handler failing, which will instead return the\nfinal state of the message."}),"\n",(0,o.jsxs)(n.p,{children:["In the next major version release (V4) this will change and the handler will\nfail if messages have encountered an uncaught error during execution. However,\nin the meantime it is possible to configure your output to use the new\n",(0,o.jsxs)(n.a,{href:"/docs/components/outputs/reject",children:[(0,o.jsx)(n.code,{children:"reject"})," output"]})," in order to trigger a handler error on\nprocessor errors:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yaml",children:"output:\n  switch:\n    retry_until_success: false\n    cases:\n      - check: '!errored()'\n        output:\n          sync_response: {}\n      - output:\n          reject: \"processing failed due to: ${! error() }\"\n"})}),"\n",(0,o.jsx)(n.h3,{id:"running-a-combination",children:"Running a combination"}),"\n",(0,o.jsxs)(n.p,{children:["It's possible to configure pipelines that send messages to third party\ndestinations and also return a result back to the caller. This is done by\nconfiguring an output block and including an output of the type\n",(0,o.jsx)(n.code,{children:"sync_response"}),"."]}),"\n",(0,o.jsxs)(n.p,{children:["For example, if we wished for our lambda function to send a payload to Kafka\nand also return the same payload back to the caller we could use a\n",(0,o.jsx)(n.a,{href:"/docs/components/outputs/broker",children:"broker"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-yml",children:"output:\n  broker:\n    pattern: fan_out\n    outputs:\n    - kafka:\n        addresses:\n        - todo:9092\n        client_id: bento_serverless\n        topic: example_topic\n    - sync_response: {}\n"})}),"\n",(0,o.jsx)(n.h2,{id:"upload-to-aws",children:"Upload to AWS"}),"\n",(0,o.jsx)(n.h3,{id:"go1x-on-x86_64",children:"go1.x on x86_64"}),"\n",(0,o.jsxs)(n.p,{children:["Grab an archive labelled ",(0,o.jsx)(n.code,{children:"bento-lambda"})," from the ",(0,o.jsx)(n.a,{href:"https://github.com/warpstreamlabs/bento/releases",children:"releases page"}),"\npage and then create your function:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:'LAMBDA_ENV=`cat yourconfig.yaml | jq -csR {Variables:{BENTO_CONFIG:.}}`\naws lambda create-function \\\n  --runtime go1.x \\\n  --handler bento-lambda \\\n  --role bento-example-role \\\n  --zip-file fileb://bento-lambda.zip \\\n  --environment "$LAMBDA_ENV" \\\n  --function-name bento-example\n'})}),"\n",(0,o.jsxs)(n.p,{children:["There is also an example ",(0,o.jsx)(n.a,{href:"https://github.com/warpstreamlabs/bento/tree/main/resources/serverless/lambda/bento-lambda-sam.yaml",children:"SAM template"})," and\n",(0,o.jsx)(n.a,{href:"https://github.com/warpstreamlabs/bento/tree/main/resources/serverless/lambda/bento-lambda.tf",children:"Terraform resource"})," in the repo to copy from."]}),"\n",(0,o.jsx)(n.h3,{id:"providedal2-on-amd64",children:"provided.al2 on amd64"}),"\n",(0,o.jsxs)(n.p,{children:["Grab an archive labelled ",(0,o.jsx)(n.code,{children:"bento-lambda-al2"})," for ",(0,o.jsx)(n.code,{children:"arm64"})," from the ",(0,o.jsx)(n.a,{href:"https://github.com/warpstreamlabs/bento/releases",children:"releases page"}),"\npage and then create your function (AWS CLI v2 only):"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:'LAMBDA_ENV=`cat yourconfig.yaml | jq -csR {Variables:{BENTO_CONFIG:.}}`\naws lambda create-function \\\n  --runtime provided.al2 \\\n  --architectures arm64 \\\n  --handler not.used.for.provided.al2.runtime \\\n  --role bento-example-role \\\n  --zip-file fileb://bento-lambda.zip \\\n  --environment "$LAMBDA_ENV" \\\n  --function-name bento-example\n'})}),"\n",(0,o.jsxs)(n.p,{children:["There is also an example ",(0,o.jsx)(n.a,{href:"https://github.com/warpstreamlabs/bento/tree/main/resources/serverless/lambda/bento-lambda-al2-sam.yaml",children:"SAM template"})," and\n",(0,o.jsx)(n.a,{href:"https://github.com/warpstreamlabs/bento/tree/main/resources/serverless/lambda/bento-lambda-al2.tf",children:"Terraform resource"})," in the repo to copy from."]}),"\n",(0,o.jsxs)(n.p,{children:["Note that you can also run ",(0,o.jsx)(n.code,{children:"bento-lambda-al2"})," on x86_64, just use the ",(0,o.jsx)(n.code,{children:"amd64"})," zip instead."]}),"\n",(0,o.jsx)(n.h2,{id:"invoke",children:"Invoke"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:'aws lambda invoke \\\n  --function-name bento-example \\\n  --payload \'{"your":"document"}\' \\\n  out.txt && cat out.txt && rm out.txt\n'})}),"\n",(0,o.jsx)(n.h2,{id:"build",children:"Build"}),"\n",(0,o.jsx)(n.p,{children:"You can build and archive the function yourself with:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"go build github.com/warpstreamlabs/bento/v4/cmd/serverless/bento-lambda\nzip bento-lambda.zip bento-lambda\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},11151:function(e,n,t){t.d(n,{Z:function(){return i},a:function(){return a}});var o=t(67294);const s={},r=o.createContext(s);function a(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);